================
Connection Guide
================

.. default-domain:: mongodb

Overview
--------

This guide shows you how to connect to MongoDB with the Node.js driver using
different connection mechanisms and configure the connection settings.

When you connect to a MongoDB server, you provide your credentials and
specific connection mechanism to the driver. The driver negotiates with the
server to verify your identity, and the server grants you permissions
appropriate to your user. If you need to set up a new user or user 
permissions on your MongoDB server, see the **Authentication** and
 **Authorization** sections in the 
 `Security <https://docs.mongodb.com/manual/security/>`_ server manual.

The Node.js driver can connect to MongoDB using any of the `authentication
mechanisms 
<https://docs.mongodb.com/manual/core/authentication/#authentication-mechanisms>`_
supported by either MongoDB Community or Enterprise edition which includes:

- ``DEFAULT``
- ``SCRAM-SHA-256``
- ``SCRAM-SHA-1``
- ``MONGODB-CR``
- ``X.509``
- ``Kerberos (GSSAPI/SSPI)`` *(MongoDB Enterprise only)*
- ``LDAP (PLAIN)`` *(MongoDB Enterprise only)*

Connection Mechanisms
---------------------

In this section, you can find descriptions and sample code for connecting to
a MongoDB server using each of the connection mechanism settings.

DEFAULT
~~~~~~~

The ``DEFAULT`` option is a fallback setting that instructs the driver to
attempt to authenticate a user and password using the first 
authentication mechanism supported by the server in the following order:

#. ``SCRAM-SHA-256``
#. ``SCRAM-SHA-1``
#. ``MONGODB-CR``

For example, if the ``DEFAULT`` option is specified, the driver attempts to 
authenticate using ``SCRAM-SHA-256``. If the server does not support
that mechanism, the driver attempts to authenticate using
``SCRAM-SHA-1``. If the server does not support that mechanism either, the 
driver attempts to authenticate using ``MONGODB-CR``.  For more information on
the challenge-response (CR) and salted challenge-response authentication 
mechanisms (SCRAM) that MongoDB supports, see the `SCRAM 
<https://docs.mongodb.com/manual/core/security-scram/>`_ section in the server
manual.

You can specify this option by omitting the ``authMechanism`` parameter of the
`URI ConnectionString
<https://docs.mongodb.com/manual/reference/connection-string/>`_ or by setting
it to the value ``DEFAULT`` as shown in the following sample code.

.. important::
   Always **URI encode** the username and password using ``encodeURIComponent``
   to ensure they are correctly parsed.
   
.. code-block:: js

   const { MongoClient } = require('mongodb');

   const usernanme = encodeURIComponent('dave');
   const password = encodeURIComponent('abc123');
   const authMechanism = 'DEFAULT';

   // Connection URL
   const url = `mongodb+srv://${username}:${password}@localhost:27017/?authMechanism=${authMechanism}`;

   const client = new MongoClient(url);

   async function run() {
     try {
       // Connect the client to the server
       await client.connect();
       console.log('Connected successfully to server');
     } finally {
       // Ensures that the client will close when you finish/error
       await client.close();
     }
   }
   run().catch(console.dir);
   
SCRAM-SHA-256
~~~~~~~~~~~~~

.. note::

   ``SCRAM-SHA-256`` is the default authentication method for MongoDB starting
   in version 4.0

The ``SCRAM-SHA-256`` option instructs the driver to attempt to authenticate
a user and password using the ``SCRAM-SHA-256`` connection mechanism.

For more information on the salted challenge-response authentication 
mechanisms (SCRAM) that MongoDB supports, see the `SCRAM 
<https://docs.mongodb.com/manual/core/security-scram/>`_ section in the server
manual.

<explain what happens if it is unsupported>

You can specify this option by setting the `authMechanism`` parameter of the 
`URI ConnectionString
<https://docs.mongodb.com/manual/reference/connection-string/>`_ to the value
``SCRAM-SHA-256`` as shown in the following sample code.

.. code-block:: js

   const { MongoClient } = require('mongodb');

   const usernanme = encodeURIComponent('dave');
   const password = encodeURIComponent('abc123');
   const authMechanism = 'SCRAM-SHA-256';

   // Connection URL
   const url = `mongodb+srv://${username}:${password}@localhost:27017/?authMechanism=${authMechanism}`;

   // Create a new MongoClient
   const client = new MongoClient(url);

   async function run() {
     try {
       // Connect the client to the server
       await client.connect();
       console.log('Connected successfully to server');
     } finally {
       // Ensures that the client will close when you finish/error
       await client.close();
     }
   }
   run().catch(console.dir);

SCRAM-SHA-1
~~~~~~~~~~~

.. note::
   ``SCRAM-SHA-1`` is the default authentication method for MongoDB versions 3.0, 3.2, 3.4, and 3.6.

The ``SCRAM-SHA-1`` option instructs the driver to attempt to authenticate
a user and password using the ``SCRAM-SHA-1`` connection mechanism.

For more information on the salted challenge-response authentication 
mechanisms (SCRAM) that MongoDB supports, see the `SCRAM 
<https://docs.mongodb.com/manual/core/security-scram/>`_ section in the server
manual.

<explain what happens if it is unsupported>

You can specify this option by setting the `authMechanism`` parameter of the 
`URI ConnectionString
<https://docs.mongodb.com/manual/reference/connection-string/>`_ to the value
``SCRAM-SHA-1`` as shown in the following sample code.

.. code-block:: js

   const { MongoClient } = require('mongodb');

   const usernanme = encodeURIComponent('dave');
   const password = encodeURIComponent('abc123');
   const authMechanism = 'SCRAM-SHA-1';

   // Connection URL
   const url = `mongodb+srv://${username}:${password}@localhost:27017/?authMechanism=${authMechanism}`;

   // Create a new MongoClient
   const client = new MongoClient(url);

   async function run() {
     try {
       // Connect the client to the server
       await client.connect();
       console.log('Connected successfully to server');
     } finally {
       // Ensures that the client will close when you finish/error
       await client.close();
     }
   }
   run().catch(console.dir);

MONGODB-CR
~~~~~~~~~~

.. warning::
   MONGODB-CR was deprecated starting in MongoDB 3.6, and is no longer supported as of MongoDB 4.0

The ``MONGODB-CR`` option instructs the driver to attempt to authenticate
a user and password using the ``MONGODB-CR`` connection mechanism.

You can specify this option by setting the `authMechanism`` parameter of the 
`URI ConnectionString
<https://docs.mongodb.com/manual/reference/connection-string/>`_ to the value
``MONGODB-CR`` as shown in the following sample code.

.. code-block:: js

   const { MongoClient } = require('mongodb');

   const usernanme = encodeURIComponent('dave');
   const password = encodeURIComponent('abc123');
   const authMechanism = 'MONGODB-CR';

   // Connection URL
   const url = `mongodb+srv://${username}:${password}@localhost:27017/?authMechanism=MONGODB-CR`;

   // Create a new MongoClient
   const client = new MongoClient(url);

   // Function to connect to the server
   async function run() {
     try {
       // Connect the client to the server
       await client.connect();
       console.log('Connected successfully to server');
     } finally {
       // Ensures that the client will close when you finish/error
       await client.close();
     }
   }
   run().catch(console.dir);

.. important::
   If you have `upgraded the authentication schema
   <https://docs.mongodb.com/manual/release-notes/3.0-scram/>`_ to ``SCRAM-SHA-1``\ , ``MONGODB-CR`` credentials will fail to authenticate.

X.509
~~~~~

The ``MONGODB-X509`` option instructs the driver to attempt to authenticate 
using an X.509 certificate and a value derived from the distinguished name (DN)
of the certificate. X.509 authentication requires the use of TLS connections
with certificate validation and is available in MongoDB 2.6 and newer.

You can specify this option by setting the following parameters of the 
`URI ConnectionString
<https://docs.mongodb.com/manual/reference/connection-string/>`_:

- Set the ``authMechanism`` parameter to ``MONGODB-X509``
- Set the ``tls`` parameter to ``true``
- Set the ``authSource`` to ``$external``

In addition to setting the connection string parameters, pass any
`TLS/SSL connection options
<https://mongodb.github.io/node-mongodb-native/3.4/tutorials/connect/tls/>`_
specific to your use case to the constructor of the new ``MongoClient``.

.. code-block:: js

   const { MongoClient } = require('mongodb');
   const fs = require('fs');

   // User name
   const username = encodeURIComponent('CN=client,OU=kerneluser,O=10Gen,L=New York City,ST=New York,C=US');
   const authSource = "$external";
   const authMechanism = 'SCRAM-SHA-1';
   const url = `mongodb+srv://${username}:${password}@server:27017?authMechanism=${authMechanism}&tls=true&authSource=${authSource}`;

   // Create a new MongoClient
   const client = new MongoClient(url, {
     tlsCertificateKeyFile: `${__dirname}/certs/x509/client.pem`,
   });

   // Function to connect to the server
   async function run() {
     try {
       // Connect the client to the server
       await client.connect();
       console.log('Connected successfully to server');
     } finally {
       // Ensures that the client will close when you finish/error
       await client.close();
     }
   }

   // Runs your code
   run();

For more information on connecting to MongoDB instance, replica set, and
sharded cluster with TLS/SSL options, see `TLS/SSL connections
<https://mongodb.github.io/node-mongodb-native/3.4/tutorials/connect/tls/>`_.

For more information on determining the *subject* name from the X.509
certificate, see the MongoDB manual
`X.509 tutorial
<https://docs.mongodb.com/manual/tutorial/configure-x509-client-authentication/#add-x-509-certificate-subject-as-a-user>`_.

Kerberos (GSSAPI/SSPI)
~~~~~~~~~~~~~~~~~~~~~~

`MongoDB Enterprise <http://www.mongodb.com/products/mongodb-enterprise>`_ 
supports proxy authentication through a Kerberos service. The Node.js driver
supports Kerberos on UNIX via the MIT Kerberos library and on Windows via the
SSPI API.

To connect using the GSSAPI authentication mechanism, specify
``authMechanism=GSSAPI`` as the mechanism in the `URI ConnectionString
<https://docs.mongodb.com/manual/reference/connection-string/>`_. Specify the user principal and the service
name in the connection string.  Use ``encodeURIComponent`` to encode the user
principal string.

The following example connects to MongoDB using Kerberos for UNIX.

.. code-block:: js

   const { MongoClient } = require('mongodb');

   // KDC Server
   const server = 'mongo-server.example.com';
   const principal = 'drivers@KERBEROS.EXAMPLE.COM';
   const urlEncodedPrincipal = encodeURIComponent(principal);

   const url = `mongodb+srv://${urlEncodedPrincipal}@${server}/?authMechanism=GSSAPI&gssapiServiceName=mongodb`;

   const client = new MongoClient(url);

   // Function to connect to the server
   async function run() {
     try {
       // Connect the client to the server
       await client.connect();
       console.log('Connected successfully to server');
     } finally {
       // Ensures that the client will close when you finish/error
       await client.close();
     }
   }

   // Runs your code
   run();

.. note::
   The method refers to the ``GSSAPI`` authentication mechanism instead of ``Kerberos`` because technically the driver authenticates via the :rfc:`GSSAPI <4752>` SASL mechanism.

LDAP (PLAIN)
~~~~~~~~~~~~

`MongoDB Enterprise <http://www.mongodb.com/products/mongodb-enterprise>`_
supports proxy authentication through a Lightweight Directory Access Protocol
(LDAP) service.

To connect using the LDAP authentication mechanism, specify
``authMechanism=PLAIN`` as the mechanism in the `URI ConnectionString
<https://docs.mongodb.com/manual/reference/connection-string/>`_.

.. code-block:: js

   const { MongoClient } = require('mongodb');

   // LDAP Server
   const server = 'ldap.example.com';
   const user = 'ldap-user';
   const pass = 'ldap-password';

   // Url
   const url = `mongodb+srv://${user}:${pass}@${server}?authMechanism=PLAIN&maxPoolSize=1`;

   // Client
   const client = new MongoClient(url);

   // Function to connect to the server
   async function run() {
     try {
       // Connect the client to the server
       await client.connect();
       console.log('Connected successfully to server');
     } finally {
       // Ensures that the client will close when you finish/error
       await client.close();
     }
   }

   // Runs your code
   run();

.. note::
   The method refers to the ``PLAIN`` authentication mechanism instead of
   ``LDAP`` because technically the driver authenticates via the :rfc:`PLAIN
   <4616>` SASL mechanism.
